<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Importa√ß√£o de Requisi√ß√µes</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
  h2 { text-align: center; }
  .header { max-width: 900px; margin: 0 auto 20px auto; text-align: center; }
  .header label { margin: 5px 10px; display: inline-block; }
  input[type="text"], input[type="date"] {
    padding: 6px; border: 1px solid #ccc; border-radius: 4px;
  }
  #tables { max-width: 1000px; margin: 0 auto; }
  .motivo-box {
    text-align: center; margin: 20px 0 10px 0;
    padding: 8px 12px; background: #e9f3ff;
    border: 1px solid #bcd; border-radius: 6px; font-weight: bold;
  }
  table {
    border-collapse: collapse; width: 100%; background: white;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1); border-radius: 6px;
    overflow: hidden; margin-bottom: 40px;
  }
  th, td { border: 1px solid #ddd; padding: 10px; text-align: center; }
  th { background: #4CAF50; color: white; font-weight: bold; }
  td[contenteditable="true"] { background: #fff8e1; outline: none; }
  h4 { text-align: center; margin-top: 30px; }
  .resumo {
    background: #fff; padding: 20px; border: 2px solid #4CAF50;
    border-radius: 8px; max-width: 900px; margin: 20px auto;
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
  }
  .resumo h3 { text-align: center; margin-top: 0; }
  .resumo p { font-size: 18px; margin: 8px 0; text-align: center; }
  .update-btn {
    display: block; margin: 20px auto; padding: 10px 20px;
    background: #4CAF50; color: white; border: none; border-radius: 6px;
    font-size: 16px; cursor: pointer;
  }
  .update-btn:hover { background: #45a049; }
</style>
</head>
<body>

<h2>üì¶ Importar Requisi√ß√µes de Equipamentos</h2>

<div class="header">
  <label>SEMANA: <input type="text" id="semana"></label>
  <label>DATA: <input type="date" id="data"></label><br>
  <label>PLACA: <input type="text" id="placa"></label>
  <label>MOTORISTA: <input type="text" id="motorista"></label><br>
  <label>CONFERENTE: <input type="text" id="conferente" value="USU√ÅRIO LOGADO"></label>
  <label>SUPERVISOR:
    <select id="supervisor">
      <option value="">Selecione...</option>
      <option>ALEXANDRE</option>
      <option>IAMARINO</option>
      <option>CLAUDINEI</option>
      <option>CLEITON</option>
      <option>EDUARDO</option>
      <option>JADILSON</option>
      <option>JONATHAN</option>
      <option>LEANDRO</option>
      <option>MARCOS</option>
      <option>MAURO</option>
      <option>RAFAEL</option>
      <option>RUI</option>
      <option>SERGIO</option>
      <option>WUILISMAR</option>
      <option>WASHINGTON</option>
    </select>
</label>

</div>

<h3 style="text-align:center;">üì§ Importar Arquivos (.xlsx)</h3>
<div style="text-align:center;">
  <input type="file" id="fileUpload" multiple accept=".xlsx">
</div>

<button class="update-btn" id="btnAtualizar">üîÑ Atualizar Totais</button>

<div id="tables"></div>
<div id="resumo"></div>

<script>
document.getElementById("supervisor").value

const tablesContainer = document.getElementById("tables");
const resumoDiv = document.getElementById("resumo");
const btnAtualizar = document.getElementById("btnAtualizar");


let grids = []; // Armazena todos os dados carregados (para recalcular depois)

function recalcularTotais() {
    let totalEquip_Carreg = 0, totalNovos_Carreg = 0, totalUsados_Carreg = 0;
    let totalEquip_Retorno = 0, totalNovos_Retorno = 0, totalUsados_Retorno = 0;

    grids.forEach(grid => {
        grid.rows.forEach(r => {
            const qtd = parseFloat(r[0]) || 0;
            const nMark = r[3].toString().trim().toUpperCase();
            const uMark = r[4].toString().trim().toUpperCase();
            const addQtd = qtd > 0 ? qtd : 1;

            if (grid.type === "carregamento") {
                totalEquip_Carreg += qtd;
                if (nMark === "X") totalNovos_Carreg += addQtd;
                if (uMark === "X") totalUsados_Carreg += addQtd;
            } else if (grid.type === "retorno") {
                totalEquip_Retorno += qtd;
                if (nMark === "X") totalNovos_Retorno += addQtd;
                if (uMark === "X") totalUsados_Retorno += addQtd;
            }
        });
    });

    resumoDiv.innerHTML = `
      <div class="resumo">
        <h3>üöö Carregamento (NOVO/TROCA/AMT)</h3>
        <p><b>Total de Equipamentos:</b> ${totalEquip_Carreg}</p>
        <p><b>Novos (N):</b> ${totalNovos_Carreg}</p>
        <p><b>Usados (U):</b> ${totalUsados_Carreg}</p>
      </div>
      <div class="resumo">
        <h3>üîÑ Retorno (RP/RT)</h3>
        <p><b>Total de Equipamentos:</b> ${totalEquip_Retorno}</p>
        <p><b>Novos (N):</b> ${totalNovos_Retorno}</p>
        <p><b>Usados (U):</b> ${totalUsados_Retorno}</p>
      </div>
    `;
}

btnAtualizar.addEventListener("click", recalcularTotais);

document.getElementById("fileUpload").addEventListener("change", function(e) {
    const files = e.target.files;
    tablesContainer.innerHTML = "";
    resumoDiv.innerHTML = "";
    grids = [];

    for (const file of files) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});

            const name = file.name.toUpperCase();
            const isCarregamento = name.includes("(NOVO)") || name.includes("(TROCA)") || name.includes("(AMT)");
            const isRetorno = name.includes("(RP)") || name.includes("(RT)");
            const isNovo = name.includes("(NOVO)");

            const cfg = isNovo
              ? { sheet: "REQUERIMENTO", motivoCell: "K9", startRow: 13, endRow: 23, startCol: 2, endCol: 6,
                  headers: ["QTD","EQUIP","MOD.","N","U"], filterQtd: true }
              : { sheet: "REQUERIMENTO MANUAL", motivoCell: "K8", startRow: 11, endRow: 21, startCol: 1, endCol: 5,
                  headers: ["QTD","EQUIP","MOD.","N","U"], filterQtd: false };

            if (!workbook.SheetNames.includes(cfg.sheet)) {
                tablesContainer.innerHTML += `<p style="color:red;text-align:center;">
                  ‚ùå O arquivo <b>${file.name}</b> n√£o possui a aba "${cfg.sheet}".
                </p>`;
                return;
            }

            const sheet = workbook.Sheets[cfg.sheet];
            const motivoCell = sheet[cfg.motivoCell];
            const motivo = motivoCell ? motivoCell.v : "N√£o informado";

            const rows = [];
            for (let r = cfg.startRow; r <= cfg.endRow; r++) {
                const linha = [];
                for (let c = cfg.startCol; c <= cfg.endCol; c++) {
                    const cellAddress = XLSX.utils.encode_cell({r: r-1, c: c});
                    const cell = sheet[cellAddress];
                    linha.push(cell ? cell.v : "");
                }

                const qtd = parseFloat(linha[0]) || 0;
                if (cfg.filterQtd && qtd <= 0) continue;
                if (linha.some(v => v !== "")) rows.push(linha);
            }

            // Armazena para futuros c√°lculos
            grids.push({
                type: isCarregamento ? "carregamento" : (isRetorno ? "retorno" : "outro"),
                rows: rows
            });

            // Cria tabela HTML
            let html = `<h4>Arquivo: ${file.name}</h4>`;
            html += `<div class="motivo-box">Motivo: ${motivo}</div>`;
            html += `<table data-index="${grids.length - 1}"><thead><tr>`;
            cfg.headers.forEach(h => html += `<th>${h}</th>`);
            html += "</tr></thead><tbody>";

            rows.forEach((row, i) => {
                html += `<tr data-row="${i}">`;
                row.forEach((cell, j) => {
                    if (j === 3 || j === 4) {
                        html += `<td contenteditable="true">${cell}</td>`;
                    } else {
                        html += `<td>${cell}</td>`;
                    }
                });
                html += "</tr>";
            });
            html += "</tbody></table>";

            tablesContainer.innerHTML += html;
        };
        reader.readAsArrayBuffer(file);
    }
});

// Escuta altera√ß√µes nas c√©lulas edit√°veis
tablesContainer.addEventListener("input", function(e) {
    const td = e.target.closest("td[contenteditable]");
    if (!td) return;

    const tr = td.parentElement;
    const table = td.closest("table");
    const gridIndex = parseInt(table.dataset.index);
    const rowIndex = parseInt(tr.dataset.row);
    const cellIndex = [...tr.children].indexOf(td);

    grids[gridIndex].rows[rowIndex][cellIndex] = td.innerText.trim().toUpperCase();

    // Atualiza automaticamente ao digitar:
    recalcularTotais();
});
</script>

</body>
</html>
