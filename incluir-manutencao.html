<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <title>Incluir Manuten√ß√£o</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <!-- üü© Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="toggle-btn" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
    <img src="logo.png" alt="Logo Marquespan" class="logo">
    <div class="usuario-logado" id="usuario-logado">üë§ Ol√°, Usu√°rio</div>
    <nav>
      <ul class="menu">
        <li><a href="dashboard.html"><i class="fas fa-chart-line"></i> <span>Dashboard</span></a></li>
        <li><a href="veiculos.html"><i class="fas fa-truck"></i> <span>Ve√≠culos</span></a></li>
        <li><a href="#"><i class="fas fa-gas-pump"></i> <span>Abastecimentos</span></a></li>
        <li class="menu-item">
          <a href="#"><i class="fas fa-tools"></i> <span>Manuten√ß√µes</span> <i class="fas fa-caret-down"></i></a>
          <ul class="submenu">
            <li><a href="incluir-manutencao.html">‚ûï Incluir Manuten√ß√£o</a></li>
            <li><a href="buscar-manutencao.html">üîç Buscar Manuten√ß√£o</a></li>
          </ul>
        </li>
        <li><a href="usuarios.html"><i class="fas fa-users"></i> Usu√°rios</a></li>
        <li><a href="carregamento.html"><i class="fas fa-truck"></i> <span>Carregamento</span></a></li>
        <li><a href="#"><i class="fas fa-file-invoice-dollar"></i> <span>Custos</span></a></li>
        <li><a href="index.html"><i class="fas fa-sign-out-alt"></i> <span>Sair</span></a></li>
      </ul>
    </nav>
  </div>

  <!-- üß± Conte√∫do principal -->
  <div class="main-content">
    <header class="header">‚ûï Incluir Manuten√ß√£o</header>

    <!-- üîÄ Abas -->
    <div class="tabs">
      <button onclick="mostrarAba('cadastro')">üìã Cadastro</button>
      <button onclick="mostrarAba('itens')">üß∞ Itens</button>
      <button onclick="mostrarAba('upload')">üìé Upload</button>
    </div>

    <!-- üìã Aba Cadastro -->
    <section id="cadastro" class="aba">
      <form id="formManutencao">
        <h3>Formul√°rio do Propriet√°rio</h3>
        <input type="text" id="usuarioLogado" disabled>
        <input type="text" id="filial" placeholder="Filial">
        <input type="text" id="titulo" placeholder="T√≠tulo da Manuten√ß√£o">
        <input type="text" id="tipo" placeholder="Tipo de Manuten√ß√£o">
        <input type="text" id="status" placeholder="Status">

        <h3>Dados da Manuten√ß√£o</h3>
        <input type="date" id="data">
        <select id="veiculo"></select> <!-- Placas via Supabase -->
        <input type="text" id="km" placeholder="Hod√¥metro/KM">
        <input type="text" id="motorista" placeholder="Motorista">

        <h3>Dados Fiscais</h3>
        <input type="text" id="fornecedor" placeholder="Fornecedor">
        <input type="text" id="notaFiscal" placeholder="Nota Fiscal">
        <input type="text" id="notaServico" placeholder="Nota Fiscal de Servi√ßo">

        <h3>Outras Informa√ß√µes</h3>
        <input type="text" id="numeroOS" placeholder="N√∫mero da OS">
        <textarea id="descricao" placeholder="Descri√ß√£o"></textarea>

        <button type="submit">‚úÖ Salvar Manuten√ß√£o</button>
      </form>
    </section>

    <!-- üß∞ Aba Itens -->
    <section id="itens" class="aba hidden">
      <h3>Itens da Manuten√ß√£o</h3>
      <form id="formItem">
        <input type="text" id="itemDescricao" placeholder="Pe√ßa ou Servi√ßo">
        <input type="number" id="itemValor" placeholder="Valor (R$)">
        <button type="button" onclick="adicionarItem()">‚ûï Adicionar Item</button>
      </form>

      <table>
        <thead>
          <tr>
            <th>Descri√ß√£o</th>
            <th>Valor (R$)</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaItens"></tbody>
      </table>

      <div><strong>Total:</strong> R$ <span id="totalItens">0.00</span></div>
    </section>

    <!-- üìé Aba Upload -->
    <section id="upload" class="aba hidden">
      <h3>Upload de Arquivos (PDF)</h3>
      <form id="formUpload">
        <input type="file" id="arquivoPDF" accept="application/pdf">
        <button type="button" onclick="adicionarArquivo()">üìé Adicionar Arquivo</button>
      </form>

      <table>
        <thead>
          <tr>
            <th>Arquivo</th>
            <th>A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="tabelaArquivos"></tbody>
      </table>
    </section>
  </div>

  <!-- üöÄ Scripts -->
  <script>
    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('collapsed');
    }

    function mostrarAba(id) {
      document.querySelectorAll('.aba').forEach(sec => sec.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
    }

    function adicionarItem() {
      const desc = document.getElementById('itemDescricao').value;
      const valor = parseFloat(document.getElementById('itemValor').value);
      if (!desc || isNaN(valor)) return;

      const linha = document.createElement('tr');
      linha.innerHTML = `
        <td>${desc}</td>
        <td>R$ ${valor.toFixed(2)}</td>
        <td><button onclick="this.parentElement.parentElement.remove(); atualizarTotal()">üóëÔ∏è</button></td>
      `;
      document.getElementById('tabelaItens').appendChild(linha);
      atualizarTotal();
    }

    function atualizarTotal() {
      let total = 0;
      document.querySelectorAll('#tabelaItens tr').forEach(row => {
        const valor = parseFloat(row.children[1].textContent.replace('R$', '').trim());
        total += valor;
      });
      document.getElementById('totalItens').textContent = total.toFixed(2);
    }

    function adicionarArquivo() {
      const input = document.getElementById('arquivoPDF');
      if (!input.files.length) return;

      const file = input.files[0];
      const linha = document.createElement('tr');
      linha.innerHTML = `
        <td>${file.name}</td>
        <td><button onclick="this.parentElement.parentElement.remove()">üóëÔ∏è</button></td>
      `;
      document.getElementById('tabelaArquivos').appendChild(linha);
      input.value = '';
    }

    document.addEventListener('DOMContentLoaded', async () => {
      const usuario = JSON.parse(localStorage.getItem('usuarioLogado'));
      if (usuario && usuario.nome) {
        document.getElementById('usuarioLogado').value = usuario.nome;
      }

      // üîÑ Buscar placas de ve√≠culos no Supabase
      const { supabase } = await import('./script/supabase.js');
      const { data, error } = await supabase.from('veiculos').select('placa');
      const select = document.getElementById('veiculo');
      if (data) {
        data.forEach(v => {
          const opt = document.createElement('option');
          opt.value = v.placa;
          opt.textContent = v.placa;
          select.appendChild(opt);
        });
      }
    });
  </script>
</body>
</html>
