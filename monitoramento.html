<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoramento de Manutenção - Marquespan</title>
  <link rel="stylesheet" href="css/index.css" />
  <link rel="stylesheet" href="css/monitoramento.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <!-- Chart.js para os gráficos -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Plugin Datalabels para exibir valores nos gráficos (opcional, mas recomendado) -->
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
  <link rel="icon" href="logo.png" type="image/png">
  <style>
    /* Ajustes para compactar os cards e caber melhor na tela */
    .kpi-grid {
        gap: 10px !important;
        margin-bottom: 15px !important;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)) !important;
    }
    .kpi-card {
        padding: 10px 15px !important;
        min-height: auto !important;
    }
    .kpi-icon {
        width: 35px !important;
        height: 35px !important;
        font-size: 1.1rem !important;
    }
    .kpi-info h3 { font-size: 0.8rem !important; margin-bottom: 2px !important; }
    .kpi-info p { font-size: 1.3rem !important; }
    
    /* Estilo para o card Roxo (Check-in Oficina) para melhor contraste */
    .kpi-card.purple {
        border-left: 4px solid #ffc107 !important;
    }
    .kpi-card.purple .kpi-icon {
        color: #ffffff !important;
        background-color: rgba(255, 193, 7, 1) !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- O menu será injetado aqui pelo menu.js -->
    <div id="menu-container"></div>
    
    <div class="main-content">
      <header class="header glass-header header-flex">
        <span><i class="fas fa-chart-line"></i> Monitoramento de Manutenção (Real-Time)</span>
        <div class="header-controls">
            <span id="last-update" class="last-update-text">Atualizado às: --:--</span>
            <button id="btn-toggle-sidebar" class="btn-glass btn-blue" title="Ocultar/Mostrar Menu"><i class="fas fa-bars"></i></button>
            <button id="btn-fullscreen" class="btn-glass btn-blue" title="Tela Cheia"><i class="fas fa-expand"></i></button>
            <button id="btn-refresh" class="btn-glass btn-blue" title="Atualizar Agora"><i class="fas fa-sync-alt"></i></button>
        </div>
      </header>

      <section class="section">
        <!-- Filtros de Período -->
        <div class="filter-bar glass-panel" style="display: flex; align-items: flex-end; gap: 15px; padding: 15px; margin-bottom: 20px;">
            <div class="form-group">
                <label for="filtroFilial">Filial:</label>
                <select id="filtroFilial" class="glass-input">
                    <option value="">Todas</option>
                </select>
            </div>
            <div class="form-group">
                <label for="dataInicial">De:</label>
                <input type="date" id="dataInicial" class="glass-input">
            </div>
            <div class="form-group">
                <label for="dataFinal">Até:</label>
                <input type="date" id="dataFinal" class="glass-input">
            </div>
            <button id="btn-aplicar-filtro" class="btn-glass btn-blue">Aplicar Filtro</button>
        </div>

        <!-- KPIs (Indicadores Chave) -->
        <div class="kpi-grid">
            <div class="kpi-card glass-card red" id="card-total-frota" style="position: relative; cursor: help;">
                <div class="kpi-icon"><i class="fas fa-truck"></i></div>
                <div class="kpi-info">
                    <h3>Total Frota</h3>
                    <p id="kpi-total-frota">0</p>
                </div>
                <!-- Tooltip para detalhamento -->
                <div id="tooltip-frota" style="display: none; position: absolute; top: 110%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; z-index: 9999; min-width: 220px; font-size: 0.85rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: none;">
                    <div style="text-align: center; margin-bottom: 8px; border-bottom: 1px solid #555; padding-bottom: 4px; font-weight: bold;">Detalhamento por Tipo</div>
                    <div id="tooltip-frota-content">Carregando...</div>
                </div>
            </div>
            <div class="kpi-card glass-card orange">
                <div class="kpi-icon"><i class="fas fa-tools"></i></div>
                <div class="kpi-info">
                    <h3>Total Manutenções</h3>
                    <p id="kpi-total-qtd">0</p>
                </div>
            </div>
            <div class="kpi-card glass-card green">
                <div class="kpi-icon"><i class="fas fa-dollar-sign"></i></div>
                <div class="kpi-info">
                    <h3>Gasto Total (Período)</h3>
                    <p id="kpi-total-valor">R$ 0,00</p>
                </div>
            </div>
            <div class="kpi-card glass-card blue" id="card-internados" style="position: relative; cursor: help;">
                <div class="kpi-icon"><i class="fas fa-hospital"></i></div>
                <div class="kpi-info">
                    <h3>Veículos Internados</h3>
                    <p id="kpi-internados">0</p>
                </div>
                <!-- Tooltip para detalhamento -->
                <div id="tooltip-internados" style="display: none; position: absolute; top: 110%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; z-index: 9999; min-width: 280px; font-size: 0.85rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: none;">
                    <div style="text-align: center; margin-bottom: 8px; border-bottom: 1px solid #555; padding-bottom: 4px; font-weight: bold;">Placas Internadas</div>
                    <div id="tooltip-internados-content">Carregando...</div>
                </div>
            </div>
            <div class="kpi-card glass-card yellow" id="card-checkin-oficina" style="position: relative; cursor: help;">
                <div class="kpi-icon"><i class="fas fa-warehouse"></i></div>
                <div class="kpi-info">
                    <h3>Check-in Oficina</h3>
                    <p id="kpi-checkin-oficina">0</p>
                </div>
                <!-- Tooltip para detalhamento -->
                <div id="tooltip-checkin-oficina" style="display: none; position: absolute; top: 110%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; z-index: 9999; min-width: 280px; font-size: 0.85rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: none;">
                    <div style="text-align: center; margin-bottom: 8px; border-bottom: 1px solid #555; padding-bottom: 4px; font-weight: bold;">Placas em Oficina</div>
                    <div id="tooltip-checkin-oficina-content">Carregando...</div>
                </div>
            </div>
            <div class="kpi-card glass-card orange" id="card-checkin-rota" style="position: relative; cursor: help;">
                <div class="kpi-icon"><i class="fas fa-road"></i></div>
                <div class="kpi-info">
                    <h3>Check-in Rota</h3>
                    <p id="kpi-checkin-rota">0</p>
                </div>
                <!-- Tooltip para detalhamento -->
                <div id="tooltip-checkin-rota" style="display: none; position: absolute; top: 110%; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); color: #fff; padding: 12px; border-radius: 8px; z-index: 9999; min-width: 280px; font-size: 0.85rem; box-shadow: 0 4px 15px rgba(0,0,0,0.3); pointer-events: none;">
                    <div style="text-align: center; margin-bottom: 8px; border-bottom: 1px solid #555; padding-bottom: 4px; font-weight: bold;">Placas em Rota</div>
                    <div id="tooltip-checkin-rota-content">Carregando...</div>
                </div>
            </div>
            <div class="kpi-card glass-card green">
                <div class="kpi-icon"><i class="fas fa-check-double"></i></div>
                <div class="kpi-info">
                    <h3>Finalizados Hoje</h3>
                    <p id="kpi-finalizados-hoje">0</p>
                </div>
            </div>
            <div class="kpi-card glass-card red">
                <div class="kpi-icon"><i class="fas fa-exclamation-circle"></i></div>
                <div class="kpi-info">
                    <h3>Total Pendentes</h3>
                    <p id="kpi-pendentes">0</p>
                </div>
            </div>
        </div>

        <!-- Grid de Gráficos -->
        <div class="charts-dashboard">
            <!-- Linha 1 -->
            <div class="chart-container glass-panel wide">
                <h3><i class="fas fa-calendar-alt"></i> Evolução de Manutenções (Quantidade vs Tempo)</h3>
                <div class="chart-wrapper">
                    <canvas id="chartEvolucao"></canvas>
                </div>
            </div>
        </div>

        <!-- Container de Gráficos com Rolagem Horizontal (Marquee) -->
        <div class="marquee-wrapper">
            <div class="marquee-track" id="marqueeTrack">
                <div class="chart-container glass-panel marquee-item">
                    <h3><i class="fas fa-gas-pump"></i> Nível dos Tanques de Combustível</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartNivelTanques"></canvas>
                    </div>
                </div>
                <!-- Os gráficos abaixo serão embaralhados via JS -->
                <div class="chart-container glass-panel marquee-item">
                    <h3><i class="fas fa-truck"></i> Top 10 Veículos com Maior Custo</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartTopPlacas"></canvas>
                    </div>
                </div>
                <div class="chart-container glass-panel marquee-item">
                    <h3><i class="fas fa-building"></i> Gastos por Oficina/Empresa</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartOficinas"></canvas>
                    </div>
                </div>
                <div class="chart-container glass-panel marquee-item">
                    <h3><i class="fas fa-chart-pie"></i> Distribuição de Status</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartStatus"></canvas>
                    </div>
                </div>
                <div class="chart-container glass-panel marquee-item">
                    <h3><i class="fas fa-clipboard-list"></i> Top 10 Serviços Mais Frequentes</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartTopServicosFreq"></canvas>
                    </div>
                </div>
                <div class="chart-container glass-panel marquee-item">
                    <h3><i class="fas fa-file-invoice-dollar"></i> Top 10 Serviços por Custo Total</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartTopServicosCusto"></canvas>
                    </div>
                </div>
                <div class="chart-container glass-panel marquee-item">
                    <h3><i class="fas fa-exclamation-triangle"></i> Veículos Pendentes/Internados</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartPendentesInternados"></canvas>
                    </div>
                </div>
                <div class="chart-container glass-panel marquee-item">
                    <h3><i class="fas fa-tools"></i> Em Manutenção Atual (Geral)</h3>
                    <div class="chart-wrapper">
                        <canvas id="chartEmManutencaoAtual"></canvas>
                    </div>
                </div>
            </div>
        </div>
      </section>
    </div>
  </div>
  <script type="module" src="./script/menu.js" defer></script>
  <script type="module" src="./script/monitoramento.js"></script>
  <script type="module">
    import { supabaseClient } from './script/supabase.js';

    document.addEventListener('DOMContentLoaded', async () => {
        const cardFrota = document.getElementById('card-total-frota');
        const tooltipFrota = document.getElementById('tooltip-frota');
        const tooltipContent = document.getElementById('tooltip-frota-content');

        if (cardFrota && tooltipFrota) {
            cardFrota.addEventListener('mouseenter', async () => {
                tooltipFrota.style.display = 'block';
                tooltipContent.innerHTML = 'Carregando...';
                
                const filial = document.getElementById('filtroFilial').value;
                
                try {
                    let query = supabaseClient.from('veiculos').select('tipo');
                    
                    if (filial) {
                        query = query.eq('filial', filial);
                    }
                    
                    const { data, error } = await query;

                    if (!error && data) {
                        const counts = {};
                        data.forEach(v => {
                            const tipo = v.tipo ? v.tipo.toUpperCase() : 'NÃO DEFINIDO';
                            counts[tipo] = (counts[tipo] || 0) + 1;
                        });

                        let detalhesHtml = '<ul style="list-style: none; padding: 0; margin: 0;">';
                        Object.entries(counts).sort((a, b) => b[1] - a[1]).forEach(([tipo, qtd]) => {
                            detalhesHtml += `<li style="display: flex; justify-content: space-between; margin-bottom: 4px; padding: 2px 0; border-bottom: 1px solid #444;">
                                <span style="color: #ddd;">${tipo}</span> <strong style="color: #fff;">${qtd}</strong>
                            </li>`;
                        });
                        detalhesHtml += '</ul>';
                        tooltipContent.innerHTML = detalhesHtml;
                    } else {
                        tooltipContent.innerHTML = 'Erro ao carregar dados.';
                    }
                } catch (err) {
                    console.error('Erro ao carregar detalhes da frota:', err);
                    tooltipContent.innerHTML = 'Erro ao carregar dados.';
                }
            });

            cardFrota.addEventListener('mouseleave', () => {
                tooltipFrota.style.display = 'none';
            });
        }

        // Lógica para Tooltip de Veículos Internados
        const cardInternados = document.getElementById('card-internados');
        const tooltipInternados = document.getElementById('tooltip-internados');
        const tooltipInternadosContent = document.getElementById('tooltip-internados-content');

        if (cardInternados && tooltipInternados) {
            cardInternados.addEventListener('mouseenter', async () => {
                tooltipInternados.style.display = 'block';
                tooltipInternadosContent.innerHTML = 'Carregando...';

                try {
                    const filial = document.getElementById('filtroFilial').value;

                    let query = supabaseClient
                        .from('coletas_manutencao_checklist')
                        .select('coletas_manutencao!inner(placa, data_hora, veiculos!inner(filial)), oficinas(nome)')
                        .eq('status', 'INTERNADO');

                    if (filial) query = query.eq('coletas_manutencao.veiculos.filial', filial);

                    const { data, error } = await query;

                    if (error) throw error;

                    if (data && data.length > 0) {
                        // Agrupa por placa para evitar duplicatas, pegando a oficina
                        const veiculosMap = new Map();
                        data.forEach(item => {
                            const placa = item.coletas_manutencao.placa;
                            const oficina = item.oficinas ? item.oficinas.nome : 'Sem Oficina';
                            if (!veiculosMap.has(placa)) veiculosMap.set(placa, oficina);
                        });

                        let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
                        
                        // Ordenar alfabeticamente pela placa
                        const sortedVeiculos = Array.from(veiculosMap.entries()).sort((a, b) => a[0].localeCompare(b[0]));

                        sortedVeiculos.forEach(([placa, oficina]) => {
                            html += `<li style="padding: 4px 0; border-bottom: 1px solid #444; color: #ddd; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold;">${placa}</span>
                                <span style="font-size: 0.85em; color: #aaa; margin-left: 10px; text-align: right;">${oficina}</span>
                            </li>`;
                        });
                        html += '</ul>';
                        tooltipInternadosContent.innerHTML = html;
                    } else {
                        tooltipInternadosContent.innerHTML = 'Nenhum veículo internado no período.';
                    }
                } catch (err) {
                    console.error('Erro ao carregar internados:', err);
                    tooltipInternadosContent.innerHTML = 'Erro ao carregar dados.';
                }
            });

            cardInternados.addEventListener('mouseleave', () => {
                tooltipInternados.style.display = 'none';
            });
        }

        // Lógica para Tooltip de Check-in Oficina
        const cardCheckinOficina = document.getElementById('card-checkin-oficina');
        const tooltipCheckinOficina = document.getElementById('tooltip-checkin-oficina');
        const tooltipCheckinOficinaContent = document.getElementById('tooltip-checkin-oficina-content');

        if (cardCheckinOficina && tooltipCheckinOficina) {
            cardCheckinOficina.addEventListener('mouseenter', async () => {
                tooltipCheckinOficina.style.display = 'block';
                tooltipCheckinOficinaContent.innerHTML = 'Carregando...';

                try {
                    const filial = document.getElementById('filtroFilial').value;

                    let query = supabaseClient
                        .from('coletas_manutencao_checklist')
                        .select('coletas_manutencao!inner(placa, data_hora, veiculos!inner(filial)), oficinas(nome)')
                        .eq('status', 'CHECK-IN OFICINA');

                    if (filial) query = query.eq('coletas_manutencao.veiculos.filial', filial);

                    const { data, error } = await query;
                    if (error) throw error;

                    if (data && data.length > 0) {
                        const veiculosMap = new Map();
                        data.forEach(item => {
                            const placa = item.coletas_manutencao.placa;
                            const oficina = item.oficinas ? item.oficinas.nome : 'Sem Oficina';
                            if (!veiculosMap.has(placa)) veiculosMap.set(placa, oficina);
                        });
                        let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
                        Array.from(veiculosMap.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([placa, oficina]) => {
                            html += `<li style="padding: 4px 0; border-bottom: 1px solid #444; color: #ddd; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold;">${placa}</span>
                                <span style="font-size: 0.85em; color: #aaa; margin-left: 10px; text-align: right;">${oficina}</span>
                            </li>`;
                        });
                        html += '</ul>';
                        tooltipCheckinOficinaContent.innerHTML = html;
                    } else {
                        tooltipCheckinOficinaContent.innerHTML = 'Nenhum veículo em oficina.';
                    }
                } catch (err) {
                    console.error('Erro ao carregar check-in oficina:', err);
                    tooltipCheckinOficinaContent.innerHTML = 'Erro ao carregar dados.';
                }
            });
            cardCheckinOficina.addEventListener('mouseleave', () => { tooltipCheckinOficina.style.display = 'none'; });
        }

        // Lógica para Tooltip de Check-in Rota
        const cardCheckinRota = document.getElementById('card-checkin-rota');
        const tooltipCheckinRota = document.getElementById('tooltip-checkin-rota');
        const tooltipCheckinRotaContent = document.getElementById('tooltip-checkin-rota-content');

        if (cardCheckinRota && tooltipCheckinRota) {
            cardCheckinRota.addEventListener('mouseenter', async () => {
                tooltipCheckinRota.style.display = 'block';
                tooltipCheckinRotaContent.innerHTML = 'Carregando...';

                try {
                    const filial = document.getElementById('filtroFilial').value;

                    let query = supabaseClient
                        .from('coletas_manutencao_checklist')
                        .select('coletas_manutencao!inner(placa, data_hora, veiculos!inner(filial)), oficinas(nome)')
                        .eq('status', 'CHECK-IN ROTA');

                    if (filial) query = query.eq('coletas_manutencao.veiculos.filial', filial);

                    const { data, error } = await query;
                    if (error) throw error;

                    if (data && data.length > 0) {
                        const veiculosMap = new Map();
                        data.forEach(item => {
                            const placa = item.coletas_manutencao.placa;
                            const oficina = item.oficinas ? item.oficinas.nome : 'Sem Oficina';
                            if (!veiculosMap.has(placa)) veiculosMap.set(placa, oficina);
                        });
                        let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
                        Array.from(veiculosMap.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([placa, oficina]) => {
                            html += `<li style="padding: 4px 0; border-bottom: 1px solid #444; color: #ddd; display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: bold;">${placa}</span>
                                <span style="font-size: 0.85em; color: #aaa; margin-left: 10px; text-align: right;">${oficina}</span>
                            </li>`;
                        });
                        html += '</ul>';
                        tooltipCheckinRotaContent.innerHTML = html;
                    } else {
                        tooltipCheckinRotaContent.innerHTML = 'Nenhum veículo em rota.';
                    }
                } catch (err) {
                    console.error('Erro ao carregar check-in rota:', err);
                    tooltipCheckinRotaContent.innerHTML = 'Erro ao carregar dados.';
                }
            });
            cardCheckinRota.addEventListener('mouseleave', () => { tooltipCheckinRota.style.display = 'none'; });
        }
    });
  </script>
  <footer class="footer">
    &copy; 2025 GTSYSTEM - Marquespan. Todos os direitos reservados.
  </footer>
</body>
</html>